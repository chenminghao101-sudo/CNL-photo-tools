<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å›¾ç‰‡å¤„ç†å·¥å…·</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, sans-serif; background: linear-gradient(135deg, #667eea, #764ba2); min-height: 100vh; padding: 12px; padding-bottom: 80px; }
        .container { max-width: 500px; margin: 0 auto; }
        h1 { color: white; text-align: center; margin-bottom: 15px; font-size: 20px; }
        .card { background: white; border-radius: 14px; padding: 15px; margin-bottom: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .card h2 { font-size: 14px; color: #333; margin-bottom: 12px; display: flex; align-items: center; gap: 6px; }
        
        .upload-area { border: 2px dashed #ddd; border-radius: 10px; padding: 30px 20px; text-align: center; }
        .upload-area.has-image { padding: 0; border: none; }
        .upload-icon { font-size: 36px; margin-bottom: 8px; }
        .upload-area input { display: none; }
        
        /* è£å‰ªå®¹å™¨ */
        .crop-container { position: relative; display: none; touch-action: none; }
        .crop-container.show { display: block; }
        .crop-image { width: 100%; display: block; border-radius: 8px; }
        
        /* é®ç½©å±‚ */
        .crop-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; }
        
        /* è£å‰ªæ¡† */
        .crop-box { position: absolute; border: 2px solid #fff; background: transparent; cursor: move; box-shadow: 0 0 0 9999px rgba(0,0,0,0.5); }
        
        /* è£å‰ªæ¡†ç½‘æ ¼çº¿ */
        .crop-grid { position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; }
        .crop-grid::before, .crop-grid::after { content: ''; position: absolute; background: rgba(255,255,255,0.4); }
        .crop-grid::before { left: 33.33%; right: 33.33%; top: 0; bottom: 0; border-left: 1px solid rgba(255,255,255,0.4); border-right: 1px solid rgba(255,255,255,0.4); }
        .crop-grid::after { top: 33.33%; bottom: 33.33%; left: 0; right: 0; border-top: 1px solid rgba(255,255,255,0.4); border-bottom: 1px solid rgba(255,255,255,0.4); }
        
        /* æ§åˆ¶ç‚¹ */
        .crop-handle { position: absolute; width: 20px; height: 20px; background: #fff; border-radius: 50%; transform: translate(-50%, -50%); box-shadow: 0 2px 6px rgba(0,0,0,0.3); }
        .crop-handle.tl { top: 0; left: 0; cursor: nwse-resize; }
        .crop-handle.tr { top: 0; right: 0; transform: translate(50%, -50%); cursor: nesw-resize; }
        .crop-handle.bl { bottom: 0; left: 0; transform: translate(-50%, 50%); cursor: nesw-resize; }
        .crop-handle.br { bottom: 0; right: 0; transform: translate(50%, 50%); cursor: nwse-resize; }
        
        /* è¾¹ç¼˜æ§åˆ¶æ¡ */
        .crop-edge { position: absolute; background: #fff; }
        .crop-edge.top, .crop-edge.bottom { height: 3px; width: 40px; left: 50%; transform: translateX(-50%); cursor: ns-resize; }
        .crop-edge.top { top: -1px; }
        .crop-edge.bottom { bottom: -1px; }
        .crop-edge.left, .crop-edge.right { width: 3px; height: 40px; top: 50%; transform: translateY(-50%); cursor: ew-resize; }
        .crop-edge.left { left: -1px; }
        .crop-edge.right { right: -1px; }
        
        .size-info { background: #f5f5f5; padding: 8px 12px; border-radius: 6px; font-size: 12px; color: #666; margin-top: 10px; }
        .crop-size-tag { position: absolute; bottom: -28px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: white; padding: 4px 10px; border-radius: 4px; font-size: 11px; white-space: nowrap; }
        
        .input-row { display: flex; gap: 8px; margin-bottom: 10px; }
        .input-row > div { flex: 1; }
        .input-row label { display: block; font-size: 11px; color: #888; margin-bottom: 3px; }
        .input-row input, .input-row select { width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 15px; text-align: center; }
        
        .checkbox { display: flex; align-items: center; gap: 8px; font-size: 13px; color: #555; margin-bottom: 10px; }
        .checkbox input { width: 18px; height: 18px; accent-color: #667eea; }
        
        .quick-btns { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 10px; }
        .quick-btn { padding: 6px 10px; border: 1px solid #e0e0e0; border-radius: 15px; background: white; font-size: 11px; color: #666; }
        .quick-btn:active { background: #667eea; color: white; border-color: #667eea; }
        
        .ratio-btns { display: flex; gap: 6px; margin-bottom: 12px; flex-wrap: wrap; }
        .ratio-btn { padding: 6px 12px; border: 1px solid #e0e0e0; border-radius: 15px; background: white; font-size: 11px; color: #666; }
        .ratio-btn.active { background: #667eea; color: white; border-color: #667eea; }
        
        .btn { width: 100%; padding: 14px; border: none; border-radius: 10px; font-size: 15px; font-weight: 600; color: white; }
        .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); }
        .btn-success { background: linear-gradient(135deg, #11998e, #38ef7d); margin-top: 10px; }
        .btn:active { opacity: 0.9; transform: scale(0.99); }
        
        #resultCanvas { width: 100%; border-radius: 8px; background: #eee; }
        .result { display: none; }
        .result.show { display: block; }
        
        .toast { position: fixed; bottom: 60px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 20px; font-size: 13px; opacity: 0; transition: 0.3s; z-index: 100; }
        .toast.show { opacity: 1; }
        
        .tab-bar { display: flex; gap: 8px; margin-bottom: 12px; }
        .tab { flex: 1; padding: 10px; text-align: center; border-radius: 8px; font-size: 13px; background: #f5f5f5; color: #666; }
        .tab.active { background: #667eea; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ–¼ï¸ å›¾ç‰‡å¤„ç†å·¥å…·</h1>

        <!-- ä¸Šä¼  -->
        <div class="card">
            <h2>ğŸ“¤ é€‰æ‹©å›¾ç‰‡</h2>
            <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                <div class="upload-icon">ğŸ“·</div>
                <p style="font-size:14px;color:#888">ç‚¹å‡»é€‰æ‹©å›¾ç‰‡</p>
                <input type="file" id="fileInput" accept="image/*">
            </div>
            <div class="crop-container" id="cropContainer">
                <img class="crop-image" id="cropImage">
                <div class="crop-box" id="cropBox">
                    <div class="crop-grid"></div>
                    <div class="crop-handle tl" data-handle="tl"></div>
                    <div class="crop-handle tr" data-handle="tr"></div>
                    <div class="crop-handle bl" data-handle="bl"></div>
                    <div class="crop-handle br" data-handle="br"></div>
                    <div class="crop-edge top" data-handle="t"></div>
                    <div class="crop-edge bottom" data-handle="b"></div>
                    <div class="crop-edge left" data-handle="l"></div>
                    <div class="crop-edge right" data-handle="r"></div>
                    <div class="crop-size-tag" id="cropSizeTag">100 Ã— 100</div>
                </div>
            </div>
            <div class="size-info" id="sizeInfo" style="display:none">
                åŸå›¾: <span id="origSize">-</span> | é€‰åŒº: <span id="selectSize">-</span>
            </div>
        </div>

        <!-- è£å‰ªæ¯”ä¾‹ -->
        <div class="card" id="ratioCard" style="display:none">
            <h2>ğŸ“ è£å‰ªæ¯”ä¾‹</h2>
            <div class="ratio-btns">
                <button class="ratio-btn active" onclick="setRatio(0)">è‡ªç”±</button>
                <button class="ratio-btn" onclick="setRatio(1)">1:1</button>
                <button class="ratio-btn" onclick="setRatio(4/3)">4:3</button>
                <button class="ratio-btn" onclick="setRatio(3/4)">3:4</button>
                <button class="ratio-btn" onclick="setRatio(16/9)">16:9</button>
                <button class="ratio-btn" onclick="setRatio(9/16)">9:16</button>
            </div>
        </div>

        <!-- è¾“å‡ºå°ºå¯¸ -->
        <div class="card">
            <h2>ğŸ“ è¾“å‡ºå°ºå¯¸</h2>
            <label class="checkbox"><input type="checkbox" id="enableResize" checked> è°ƒæ•´å°ºå¯¸</label>
            <label class="checkbox"><input type="checkbox" id="keepRatio" checked> ä¿æŒå®½é«˜æ¯”</label>
            <div class="quick-btns">
                <button class="quick-btn" onclick="setSize(50,50)">50Â²</button>
                <button class="quick-btn" onclick="setSize(100,100)">100Â²</button>
                <button class="quick-btn" onclick="setSize(200,200)">200Â²</button>
                <button class="quick-btn" onclick="setSize(500,500)">500Â²</button>
                <button class="quick-btn" onclick="setSize(800,600)">800Ã—600</button>
                <button class="quick-btn" onclick="setSize(1080,1920)">1080Ã—1920</button>
            </div>
            <div class="input-row">
                <div><label>å®½åº¦ px</label><input type="number" id="outW" value="200"></div>
                <div><label>é«˜åº¦ px</label><input type="number" id="outH" value="200"></div>
            </div>
        </div>

        <!-- æ ¼å¼ -->
        <div class="card">
            <h2>ğŸ’¾ è¾“å‡ºæ ¼å¼</h2>
            <div class="input-row">
                <div>
                    <select id="fmt">
                        <option value="png">PNG (é€æ˜)</option>
                        <option value="jpeg">JPG (å°ä½“ç§¯)</option>
                        <option value="webp">WebP (æœ€å°)</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- å¤„ç†æŒ‰é’® -->
        <div class="card">
            <button class="btn btn-primary" onclick="process()">âœ¨ å¤„ç†å›¾ç‰‡</button>
        </div>

        <!-- ç»“æœ -->
        <div class="card result" id="resultCard">
            <h2>ğŸ‰ å¤„ç†å®Œæˆ</h2>
            <canvas id="resultCanvas"></canvas>
            <div class="size-info">è¾“å‡º: <span id="outSize">-</span></div>
            <button class="btn btn-success" onclick="download()">ğŸ“¥ ä¿å­˜åˆ°ç›¸å†Œ</button>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // å…¨å±€å˜é‡
        let originalImg = null;
        let imgRatio = 1;
        let cropRatio = 0; // 0 = è‡ªç”±æ¯”ä¾‹
        let scale = 1; // æ˜¾ç¤ºå›¾ç‰‡ä¸åŸå›¾çš„æ¯”ä¾‹

        // è£å‰ªæ¡†çŠ¶æ€
        const cropBox = document.getElementById('cropBox');
        const cropContainer = document.getElementById('cropContainer');
        const cropImage = document.getElementById('cropImage');
        
        let boxState = { x: 20, y: 20, w: 100, h: 100 };
        let dragging = null;
        let startPos = { x: 0, y: 0 };
        let startBox = { x: 0, y: 0, w: 0, h: 0 };

        // æ–‡ä»¶é€‰æ‹©
        document.getElementById('fileInput').onchange = function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(ev) {
                const img = new Image();
                img.onload = function() {
                    originalImg = img;
                    imgRatio = img.height / img.width;
                    cropImage.src = ev.target.result;
                    
                    document.getElementById('uploadArea').style.display = 'none';
                    cropContainer.classList.add('show');
                    document.getElementById('ratioCard').style.display = 'block';
                    document.getElementById('sizeInfo').style.display = 'block';
                    document.getElementById('origSize').textContent = img.width + ' Ã— ' + img.height;
                    
                    setTimeout(initCropBox, 100);
                    toast('å›¾ç‰‡å·²åŠ è½½ï¼Œæ‹–åŠ¨æ–¹æ¡†è£å‰ª');
                };
                img.src = ev.target.result;
            };
            reader.readAsDataURL(file);
        };

        function initCropBox() {
            const rect = cropImage.getBoundingClientRect();
            scale = originalImg.width / rect.width;
            
            const size = Math.min(rect.width, rect.height) * 0.8;
            boxState = {
                x: (rect.width - size) / 2,
                y: (rect.height - size) / 2,
                w: size,
                h: size
            };
            updateCropBox();
        }

        function updateCropBox() {
            cropBox.style.left = boxState.x + 'px';
            cropBox.style.top = boxState.y + 'px';
            cropBox.style.width = boxState.w + 'px';
            cropBox.style.height = boxState.h + 'px';
            
            const realW = Math.round(boxState.w * scale);
            const realH = Math.round(boxState.h * scale);
            document.getElementById('cropSizeTag').textContent = realW + ' Ã— ' + realH;
            document.getElementById('selectSize').textContent = realW + ' Ã— ' + realH;
        }

        // è§¦æ‘¸/é¼ æ ‡äº‹ä»¶
        cropBox.addEventListener('mousedown', startDrag);
        cropBox.addEventListener('touchstart', startDrag, { passive: false });
        document.addEventListener('mousemove', onDrag);
        document.addEventListener('touchmove', onDrag, { passive: false });
        document.addEventListener('mouseup', endDrag);
        document.addEventListener('touchend', endDrag);

        function getPos(e) {
            const touch = e.touches ? e.touches[0] : e;
            const rect = cropContainer.getBoundingClientRect();
            return { x: touch.clientX - rect.left, y: touch.clientY - rect.top };
        }

        function startDrag(e) {
            e.preventDefault();
            const target = e.target;
            const handle = target.dataset.handle;
            
            dragging = handle || 'move';
            startPos = getPos(e);
            startBox = { ...boxState };
        }

        function onDrag(e) {
            if (!dragging) return;
            e.preventDefault();
            
            const pos = getPos(e);
            const dx = pos.x - startPos.x;
            const dy = pos.y - startPos.y;
            const imgRect = cropImage.getBoundingClientRect();
            const maxW = imgRect.width;
            const maxH = imgRect.height;
            const minSize = 30;

            if (dragging === 'move') {
                boxState.x = Math.max(0, Math.min(maxW - boxState.w, startBox.x + dx));
                boxState.y = Math.max(0, Math.min(maxH - boxState.h, startBox.y + dy));
            } else {
                let newX = startBox.x, newY = startBox.y, newW = startBox.w, newH = startBox.h;

                if (dragging.includes('l')) { newX = startBox.x + dx; newW = startBox.w - dx; }
                if (dragging.includes('r') || dragging === 'r') { newW = startBox.w + dx; }
                if (dragging.includes('t')) { newY = startBox.y + dy; newH = startBox.h - dy; }
                if (dragging.includes('b') || dragging === 'b') { newH = startBox.h + dy; }

                if (cropRatio > 0) {
                    if (dragging.includes('l') || dragging.includes('r') || dragging === 'l' || dragging === 'r') {
                        newH = newW / cropRatio;
                    } else {
                        newW = newH * cropRatio;
                    }
                }

                if (newW >= minSize && newH >= minSize && newX >= 0 && newY >= 0 && newX + newW <= maxW && newY + newH <= maxH) {
                    boxState = { x: newX, y: newY, w: newW, h: newH };
                }
            }
            updateCropBox();
        }

        function endDrag() { dragging = null; }

        // è®¾ç½®è£å‰ªæ¯”ä¾‹
        function setRatio(r) {
            cropRatio = r;
            document.querySelectorAll('.ratio-btn').forEach((btn, i) => {
                btn.classList.toggle('active', (r === 0 && i === 0) || (r === 1 && i === 1) || (r === 4/3 && i === 2) || (r === 3/4 && i === 3) || (r === 16/9 && i === 4) || (r === 9/16 && i === 5));
            });
            if (r > 0 && originalImg) {
                const imgRect = cropImage.getBoundingClientRect();
                let newW = boxState.w, newH = boxState.w / r;
                if (newH > imgRect.height * 0.9) { newH = imgRect.height * 0.9; newW = newH * r; }
                boxState.w = newW;
                boxState.h = newH;
                boxState.x = Math.min(boxState.x, imgRect.width - newW);
                boxState.y = Math.min(boxState.y, imgRect.height - newH);
                updateCropBox();
            }
        }

        // è®¾ç½®è¾“å‡ºå°ºå¯¸
        function setSize(w, h) {
            document.getElementById('outW').value = w;
            document.getElementById('outH').value = h;
        }

        document.getElementById('outW').oninput = function() {
            if (document.getElementById('keepRatio').checked && originalImg) {
                const cropH = boxState.h * scale, cropW = boxState.w * scale;
                document.getElementById('outH').value = Math.round(this.value * (cropH / cropW));
            }
        };

        // å¤„ç†å›¾ç‰‡
        function process() {
            if (!originalImg) { toast('è¯·å…ˆé€‰æ‹©å›¾ç‰‡'); return; }

            const sx = Math.round(boxState.x * scale);
            const sy = Math.round(boxState.y * scale);
            const sw = Math.round(boxState.w * scale);
            const sh = Math.round(boxState.h * scale);

            let dw = sw, dh = sh;
            if (document.getElementById('enableResize').checked) {
                dw = parseInt(document.getElementById('outW').value) || sw;
                dh = parseInt(document.getElementById('outH').value) || sh;
            }

            const canvas = document.getElementById('resultCanvas');
            canvas.width = dw;
            canvas.height = dh;
            canvas.getContext('2d').drawImage(originalImg, sx, sy, sw, sh, 0, 0, dw, dh);

            document.getElementById('outSize').textContent = dw + ' Ã— ' + dh;
            document.getElementById('resultCard').classList.add('show');
            document.getElementById('resultCard').scrollIntoView({ behavior: 'smooth' });
            toast('å¤„ç†å®Œæˆï¼');
        }

        // ä¸‹è½½
        function download() {
            const canvas = document.getElementById('resultCanvas');
            const fmt = document.getElementById('fmt').value;
            const link = document.createElement('a');
            link.download = 'image_' + Date.now() + '.' + fmt;
            link.href = canvas.toDataURL('image/' + fmt, 0.92);
            link.click();
            toast('å·²ä¿å­˜');
        }

        function toast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        }
    </script>
</body>
</html>
