<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CNL-Emojiè¡¨æƒ…åˆ¶ä½œå™¨</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        .bg-cover {
            position: fixed;
            /* ä¿®å¤ï¼šå°†è´Ÿå€¼æ”¹ä¸º 0ï¼Œæ¶ˆé™¤æº¢å‡ºå¯¼è‡´çš„é˜´å½± */
            top: 0; left: 0; right: 0; bottom: 0;
            background: #1a1d2e;
            z-index: -1;
        }
        
        html, body {
            background: #1a1d2e;
            min-height: 100vh;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: #fff;
            padding: 12px;
            overflow-x: hidden;
        }
        .header { text-align: center; padding: 16px 0 20px; }
        .header h1 { 
            font-size: 22px; 
            background: linear-gradient(135deg, #00d4ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .container { max-width: 500px; margin: 0 auto; }
        
        .card {
            background: linear-gradient(145deg, #252a3e, #1e2235);
            border-radius: 16px;
            padding: 18px;
            margin-bottom: 14px;
        }
        .card-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .step-num {
            width: 26px; height: 26px;
            background: linear-gradient(135deg, #00d4ff, #00a8cc);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: bold;
            color: #1a1d2e;
        }
        
        .upload-area {
            background: #2a2f45;
            border: 2px dashed #3d4460;
            border-radius: 12px;
            padding: 45px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .upload-area:active { background: #323850; border-color: #00d4ff; }
        .upload-icon { font-size: 48px; margin-bottom: 10px; }
        .upload-text { color: #8899aa; font-size: 14px; }
        #fileInput { display: none; }

        .crop-container { position: relative; background: #000; border-radius: 10px; overflow: hidden; }
        #cropImage { max-width: 100%; max-height: 50vh; display: block; margin: 0 auto; }
        
        /* å…³é”®ä¿®å¤ï¼šcrop-box é»˜è®¤å®Œå…¨éšè— */
        .crop-box { 
            position: absolute; 
            border: 2px solid #00d4ff;
            display: none;  /* é»˜è®¤éšè— */
        }
        .crop-box.active { 
            display: block;
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.6);
        }
        
        .grid-line { position: absolute; background: rgba(255,255,255,0.3); pointer-events: none; }
        .grid-line.h1 { left: 0; right: 0; top: 33.33%; height: 1px; }
        .grid-line.h2 { left: 0; right: 0; top: 66.66%; height: 1px; }
        .grid-line.v1 { top: 0; bottom: 0; left: 33.33%; width: 1px; }
        .grid-line.v2 { top: 0; bottom: 0; left: 66.66%; width: 1px; }
        .crop-move { position: absolute; inset: 0; cursor: move; }
        .crop-info { position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.75); color: #fff; padding: 4px 10px; border-radius: 4px; font-size: 11px; pointer-events: none; }
        .crop-handle { position: absolute; width: 26px; height: 26px; background: #fff; border-radius: 50%; border: 3px solid #00d4ff; z-index: 10; }
        .crop-handle.tl { top: -13px; left: -13px; cursor: nwse-resize; }
        .crop-handle.tr { top: -13px; right: -13px; cursor: nesw-resize; }
        .crop-handle.bl { bottom: -13px; left: -13px; cursor: nesw-resize; }
        .crop-handle.br { bottom: -13px; right: -13px; cursor: nwse-resize; }

        .ratio-bar { display: flex; gap: 8px; margin-bottom: 14px; flex-wrap: wrap; }
        .ratio-btn {
            padding: 8px 14px;
            background: #3d4460;
            border: none;
            color: #ccc;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }
        .ratio-btn.active { background: linear-gradient(135deg, #00d4ff, #00a8cc); color: #1a1d2e; font-weight: 600; }

        .preview-area { margin-top: 16px; padding-top: 16px; border-top: 1px solid #3d4460; }
        .preview-label { color: #8899aa; font-size: 12px; margin-bottom: 8px; }
        .preview-wrap { background: #1a1d2e; border-radius: 8px; padding: 12px; text-align: center; min-height: 60px; display: flex; align-items: center; justify-content: center; }
        #previewCanvas { max-width: 100%; max-height: 100px; border-radius: 4px; }

        .btn-group { display: flex; gap: 10px; margin-top: 16px; }
        .btn { flex: 1; padding: 14px; border: none; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn:active { transform: scale(0.97); }
        .btn-secondary { background: #3d4460; color: #fff; }
        .btn-primary { background: linear-gradient(135deg, #00d4ff, #00a8cc); color: #1a1d2e; }
        .btn-success { background: linear-gradient(135deg, #00ff88, #00cc6a); color: #1a1d2e; }

        .resize-img { text-align: center; margin-bottom: 16px; }
        .resize-img img { max-width: 100%; max-height: 40vh; border-radius: 10px; }
        .size-label { color: #8899aa; font-size: 13px; margin-top: 10px; }

        .size-inputs { display: flex; gap: 12px; align-items: center; margin: 16px 0; }
        .input-group { flex: 1; }
        .input-group label { display: block; color: #8899aa; font-size: 12px; margin-bottom: 6px; }
        .input-group input { width: 100%; padding: 12px; background: #2a2f45; border: 1px solid #3d4460; border-radius: 10px; color: #fff; font-size: 16px; text-align: center; }
        .input-group input:focus { outline: none; border-color: #00d4ff; }
        .link-toggle { width: 42px; height: 42px; background: #3d4460; border: none; border-radius: 50%; color: #fff; cursor: pointer; font-size: 18px; margin-top: 18px; transition: all 0.2s; }
        .link-toggle.active { background: #00d4ff; color: #1a1d2e; }

        .presets { display: flex; flex-wrap: wrap; gap: 8px; }
        .preset-btn { padding: 8px 14px; background: #2a2f45; border: 1px solid #3d4460; color: #ccc; border-radius: 16px; cursor: pointer; font-size: 12px; transition: all 0.2s; }
        .preset-btn:active { background: #3d4460; }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 1000; justify-content: center; align-items: center; flex-direction: column; padding: 20px; }
        .modal.show { display: flex; }
        .modal img { max-width: 90%; max-height: 50vh; border-radius: 12px; }
        .modal-text { color: #aaa; text-align: center; margin-top: 20px; font-size: 14px; line-height: 1.8; }
        .modal-btns { display: flex; gap: 12px; margin-top: 24px; }
        .modal-btns .btn { padding: 14px 32px; flex: none; }

        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="bg-cover"></div>
    
    <div class="header"><h1>âœ¨ CNL-Emojiè¡¨æƒ…åˆ¶ä½œå™¨</h1></div>
    <div class="container">
        <div class="card" id="step1">
            <div class="card-title"><span class="step-num">1</span> é€‰æ‹©å›¾ç‰‡</div>
            <label class="upload-area" for="fileInput">
                <div class="upload-icon">ğŸ“</div>
                <div class="upload-text">ç‚¹å‡»é€‰æ‹©å›¾ç‰‡</div>
            </label>
            <input type="file" id="fileInput" accept="image/*">
        </div>

        <div class="card hidden" id="step2">
            <div class="card-title"><span class="step-num">2</span> è£å‰ªå›¾ç‰‡</div>
            <div class="ratio-bar">
                <button class="ratio-btn active" data-ratio="free">è‡ªç”±</button>
                <button class="ratio-btn" data-ratio="1:1">1:1</button>
                <button class="ratio-btn" data-ratio="4:3">4:3</button>
                <button class="ratio-btn" data-ratio="3:4">3:4</button>
                <button class="ratio-btn" data-ratio="16:9">16:9</button>
            </div>
            <div class="crop-container" id="cropContainer">
                <img id="cropImage" src="">
                <div class="crop-box" id="cropBox">
                    <div class="grid-line h1"></div><div class="grid-line h2"></div>
                    <div class="grid-line v1"></div><div class="grid-line v2"></div>
                    <div class="crop-move" id="cropMove"></div>
                    <div class="crop-handle tl" data-h="tl"></div>
                    <div class="crop-handle tr" data-h="tr"></div>
                    <div class="crop-handle bl" data-h="bl"></div>
                    <div class="crop-handle br" data-h="br"></div>
                    <div class="crop-info" id="cropInfo">0 Ã— 0</div>
                </div>
            </div>
            <div class="preview-area">
                <div class="preview-label">å®æ—¶é¢„è§ˆ</div>
                <div class="preview-wrap"><canvas id="previewCanvas"></canvas></div>
            </div>
            <div class="btn-group">
                <button class="btn btn-secondary" id="backBtn1">è¿”å›</button>
                <button class="btn btn-secondary" id="skipBtn">è·³è¿‡</button>
                <button class="btn btn-primary" id="cropBtn">ç¡®è®¤è£å‰ª</button>
            </div>
        </div>

        <div class="card hidden" id="step3">
            <div class="card-title"><span class="step-num">3</span> è°ƒæ•´å°ºå¯¸</div>
            <div class="resize-img">
                <img id="resizeImg" src="">
                <div class="size-label">å½“å‰å°ºå¯¸: <span id="curSize">0 Ã— 0</span></div>
            </div>
            <div class="size-inputs">
                <div class="input-group"><label>å®½åº¦ (px)</label><input type="number" id="wInput" min="1" max="4096"></div>
                <button class="link-toggle active" id="linkBtn">ğŸ”—</button>
                <div class="input-group"><label>é«˜åº¦ (px)</label><input type="number" id="hInput" min="1" max="4096"></div>
            </div>
            <div class="presets">
                <button class="preset-btn" data-s="64">64px</button>
                <button class="preset-btn" data-s="128">128px</button>
                <button class="preset-btn" data-s="256">256px</button>
                <button class="preset-btn" data-s="512">512px</button>
                <button class="preset-btn" data-s="1024">1024px</button>
            </div>
            <div class="btn-group">
                <button class="btn btn-secondary" id="backBtn2">è¿”å›è£å‰ª</button>
                <button class="btn btn-success" id="saveBtn">ğŸ’¾ ä¿å­˜å›¾ç‰‡</button>
            </div>
        </div>
    </div>

    <div class="modal" id="modal">
        <img id="finalImg" src="">
        <div class="modal-text">ğŸ“± é•¿æŒ‰å›¾ç‰‡ä¿å­˜åˆ°ç›¸å†Œ<br>ğŸ’» ç”µè„‘ç«¯ç‚¹å‡»ä¸‹è½½æŒ‰é’®</div>
        <div class="modal-btns">
            <button class="btn btn-primary" id="dlBtn">â¬‡ï¸ ä¸‹è½½</button>
            <button class="btn btn-secondary" id="closeBtn">å…³é—­</button>
        </div>
    </div>

    <script>
        const $ = id => document.getElementById(id);
        let img, cropped, box = {x:0,y:0,w:100,h:100}, drag=0, rsz=0, hnd='', sx, sy, sb, ratio=null, sc=1, lock=1, iR=1;

        $('fileInput').onchange = e => { const f=e.target.files[0]; if(!f)return; const r=new FileReader(); r.onload=ev=>{const i=new Image();i.onload=()=>{img=i;show(2)};i.src=ev.target.result}; r.readAsDataURL(f); };

        function show(n) { 
            $('step1').classList.toggle('hidden',n!==1); 
            $('step2').classList.toggle('hidden',n!==2); 
            $('step3').classList.toggle('hidden',n!==3); 
            $('cropBox').classList.remove('active');
            if(n===2){$('cropImage').src=img.src;setTimeout(init,50)} 
        }
        function init() { 
            sc=img.naturalWidth/$('cropImage').width; 
            const s=Math.min($('cropImage').width,$('cropImage').height)*0.7; 
            box={x:($('cropImage').width-s)/2,y:($('cropImage').height-s)/2,w:s,h:s}; 
            upd(); 
            $('cropBox').classList.add('active');
        }
        function upd() { $('cropBox').style.cssText=`left:${box.x}px;top:${box.y}px;width:${box.w}px;height:${box.h}px`; $('cropInfo').textContent=`${Math.round(box.w*sc)} Ã— ${Math.round(box.h*sc)}`; const c=$('previewCanvas'),ctx=c.getContext('2d'),w=Math.round(box.w*sc),h=Math.round(box.h*sc); c.width=w;c.height=h;ctx.drawImage(img,box.x*sc,box.y*sc,w,h,0,0,w,h); }
        function pos(e){const r=$('cropContainer').getBoundingClientRect(),t=e.touches?.[0]||e;return{x:t.clientX-r.left,y:t.clientY-r.top}}
        function start(e){e.preventDefault();const p=pos(e);sx=p.x;sy=p.y;sb={...box};rsz=e.target.classList.contains('crop-handle');hnd=rsz?e.target.dataset.h:'';drag=!rsz}
        function move(e){if(!drag&&!rsz)return;e.preventDefault();const p=pos(e),dx=p.x-sx,dy=p.y-sy,iw=$('cropImage').width,ih=$('cropImage').height; if(drag){box.x=Math.max(0,Math.min(sb.x+dx,iw-box.w));box.y=Math.max(0,Math.min(sb.y+dy,ih-box.h))} if(rsz){let n={...sb};if(hnd.includes('r'))n.w=Math.max(30,sb.w+dx);if(hnd.includes('l')){n.x=sb.x+dx;n.w=Math.max(30,sb.w-dx)}if(hnd.includes('b'))n.h=Math.max(30,sb.h+dy);if(hnd.includes('t')){n.y=sb.y+dy;n.h=Math.max(30,sb.h-dy)}if(ratio)n.h=n.w/ratio;n.x=Math.max(0,n.x);n.y=Math.max(0,n.y);n.w=Math.min(n.w,iw-n.x);n.h=Math.min(n.h,ih-n.y);box=n}upd()}
        function end(){drag=0;rsz=0}

        $('cropMove').addEventListener('mousedown',start);$('cropMove').addEventListener('touchstart',start,{passive:false});
        document.querySelectorAll('.crop-handle').forEach(h=>{h.addEventListener('mousedown',start);h.addEventListener('touchstart',start,{passive:false})});
        document.addEventListener('mousemove',move);document.addEventListener('touchmove',move,{passive:false});
        document.addEventListener('mouseup',end);document.addEventListener('touchend',end);

        document.querySelectorAll('.ratio-btn').forEach(b=>{b.onclick=()=>{document.querySelectorAll('.ratio-btn').forEach(x=>x.classList.remove('active'));b.classList.add('active');const r=b.dataset.ratio;ratio=r==='free'?null:r.split(':').map(Number).reduce((a,b)=>a/b);if(ratio){box.h=box.w/ratio;upd()}}});

        $('backBtn1').onclick=()=>{show(1);$('fileInput').value=''};
        $('skipBtn').onclick=()=>{cropped=img.src;toS3()};
        $('cropBtn').onclick=()=>{cropped=$('previewCanvas').toDataURL('image/png');toS3()};
        $('backBtn2').onclick=()=>show(2);

        function toS3(){show(3);$('resizeImg').src=cropped;const i=new Image();i.onload=()=>{iR=i.naturalWidth/i.naturalHeight;$('wInput').value=i.naturalWidth;$('hInput').value=i.naturalHeight;$('curSize').textContent=`${i.naturalWidth} Ã— ${i.naturalHeight}`};i.src=cropped}

        $('linkBtn').onclick=()=>{lock=!lock;$('linkBtn').classList.toggle('active',lock)};
        $('wInput').oninput=()=>{if(lock)$('hInput').value=Math.round($('wInput').value/iR)};
        $('hInput').oninput=()=>{if(lock)$('wInput').value=Math.round($('hInput').value*iR)};
        document.querySelectorAll('.preset-btn').forEach(b=>{b.onclick=()=>{$('wInput').value=b.dataset.s;if(lock)$('hInput').value=Math.round(b.dataset.s/iR)}});

        $('saveBtn').onclick=()=>{const w=+$('wInput').value,h=+$('hInput').value,i=new Image();i.onload=()=>{const c=document.createElement('canvas'),ctx=c.getContext('2d');c.width=w;c.height=h;ctx.drawImage(i,0,0,w,h);$('finalImg').src=c.toDataURL('image/png');$('modal').classList.add('show')};i.src=cropped};
        $('dlBtn').onclick=()=>{const a=document.createElement('a');a.download='emoji-'+Date.now()+'.png';a.href=$('finalImg').src;a.click()};
        $('closeBtn').onclick=()=>$('modal').classList.remove('show');
        $('modal').onclick=e=>{if(e.target===$('modal'))$('modal').classList.remove('show')};
    </script>
</body>
</html>
